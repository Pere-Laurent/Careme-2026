<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Car√™me 2026 ‚Äì Objectifs</title>
  <style>
    :root{
      --bg:#0b1220; --card:#111a2e; --text:#e8eefc; --muted:#a7b4d6;
      --accent:#7aa2ff; --ok:#4ade80; --warn:#fbbf24; --bad:#fb7185;
      --line:rgba(255,255,255,.10);
    }
    body{ margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:linear-gradient(180deg,#070b14,var(--bg)); color:var(--text); }
    .wrap{ max-width:1020px; margin:0 auto; padding:18px; }
    .card{ background:rgba(17,26,46,.88); border:1px solid rgba(122,162,255,.15);
      border-radius:16px; padding:16px; box-shadow:0 10px 30px rgba(0,0,0,.25); }
    h1{ font-size:20px; margin:0 0 6px; }
    h2{ font-size:14px; margin:14px 0 8px; color:var(--muted); font-weight:800; }
    .sub{ color:var(--muted); font-size:13px; margin:0 0 10px; line-height:1.45; }
    .row{ display:flex; gap:12px; flex-wrap:wrap; align-items:center; justify-content:space-between; }
    .pill{ font-size:12px; color:var(--muted); border:1px solid var(--line); padding:6px 10px; border-radius:999px; }
    .btn{ background:rgba(122,162,255,.14); color:var(--text); border:1px solid rgba(122,162,255,.35);
      padding:10px 12px; border-radius:12px; cursor:pointer; text-decoration:none; display:inline-flex; align-items:center; gap:8px; }
    .btn:active{ transform:translateY(1px); }
    .btn[aria-disabled="true"]{ opacity:.45; pointer-events:none; }
    .btn.secondary{ background:rgba(255,255,255,.08); border:1px solid var(--line); }
    .btn.warn{ background:rgba(251,191,36,.10); border:1px solid rgba(251,191,36,.35); }
    .btn.bad{ background:rgba(251,113,133,.10); border:1px solid rgba(251,113,133,.35); }
    .progress{ width:100%; height:10px; background:rgba(255,255,255,.10); border-radius:999px; overflow:hidden; }
    .bar{ height:100%; width:0%; background:linear-gradient(90deg,var(--accent),var(--ok)); transition:width .25s ease; }
    .grid{ display:grid; gap:12px; }
    @media (min-width: 940px){ .grid{ grid-template-columns:1.1fr .9fr; } }

    ul{ list-style:none; padding:0; margin:0; display:flex; flex-direction:column; gap:8px; }
    li{ display:flex; gap:10px; align-items:flex-start; padding:10px; border-radius:12px;
      background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.08); }
    input[type="checkbox"]{ transform:scale(1.25); margin-top:2px; }
    .task{ flex:1; }
    .task b{ display:block; font-weight:800; }
    .meta{ color:var(--muted); font-size:12px; margin-top:2px; }
    .tag{ display:inline-block; font-size:11px; padding:2px 8px; border-radius:999px; border:1px solid var(--line); color:var(--muted); margin-left:6px; }

    .section{ padding:12px; border-radius:14px; border:1px solid var(--line); background:rgba(0,0,0,.12); }
    .foot{ margin-top:10px; color:var(--muted); font-size:12px; line-height:1.45; }
    .hr{ height:1px; background:var(--line); margin:12px 0; }

    select, textarea, input[type="text"]{
      background:rgba(0,0,0,.18); color:var(--text);
      border:1px solid rgba(255,255,255,.14); border-radius:12px; padding:10px 12px; font:inherit;
    }
    select{ padding-right:34px; }
    textarea{ width:100%; min-height:120px; }
    .quote{ padding:10px 12px; border-radius:12px; border:1px solid rgba(255,255,255,.12); background:rgba(255,255,255,.05); }
    .quote b{ font-weight:900; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .hidden{ display:none; }

    /* Modal */
    .modal-backdrop{
      position:fixed; inset:0; background:rgba(0,0,0,.55);
      display:none; align-items:center; justify-content:center; padding:16px;
    }
    .modal{
      width:min(560px, 100%);
      background:rgba(17,26,46,.98);
      border:1px solid rgba(255,255,255,.14);
      border-radius:16px; padding:14px;
      box-shadow:0 20px 60px rgba(0,0,0,.45);
    }
    .modal h3{ margin:0 0 8px; font-size:16px; }
    .modal p{ margin:0 0 10px; color:var(--muted); font-size:13px; line-height:1.45; }
    .modal .row{ justify-content:flex-end; }
    .modal input[type="text"]{ width:100%; margin-top:6px; }
    .modal .danger-note{ color:var(--bad); font-weight:700; }
    .modal-backdrop.show{ display:flex; }
  </style>
</head>

<body>
<div class="wrap">
  <div class="card">
    <div class="row">
      <div>
        <h1>Car√™me 2026 ‚Äì Objectifs</h1>
        <p class="sub" id="dateLabel"></p>
      </div>
      <div class="pill" id="rangeLabel"></div>
    </div>

    <!-- Accueil pastoral + citation du niveau + parole courte -->
    <div class="quote" style="margin-top:10px">
      <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:flex-start; justify-content:space-between">
        <div style="flex:1; min-width:260px">
          <b>Bienvenue</b> üëã<br/>
          <span class="sub" style="margin:6px 0 0; display:block">
            Ce Car√™me, avan√ßons pas √† pas : pri√®re, sobri√©t√©, charit√©. Le but n‚Äôest pas la performance,
            mais la fid√©lit√© du c≈ìur. Un jour √† la fois.
          </span>
        </div>
        <div style="flex:1; min-width:260px">
          <b id="levelTitle">Niveau</b><br/>
          <span class="sub" id="levelQuote" style="margin:6px 0 0; display:block"></span>
        </div>
      </div>
      <div class="hr"></div>
      <div>
        <b>Parole du jour</b><br/>
        <span class="sub" id="shortQuote" style="margin:6px 0 0; display:block"></span>
      </div>
    </div>

    <div class="row" style="margin-top:12px">
      <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center">
        <span class="pill">Niveau</span>
        <select id="levelSelect" aria-label="Niveau">
          <option value="mustard">Le grain de s√©nev√©</option>
          <option value="vine">Le cep et les sarments</option>
          <option value="fire">Feu d√©vorant</option>
        </select>

        <label class="pill" style="display:flex; gap:8px; align-items:center">
          <input id="animatorToggle" type="checkbox" style="transform:scale(1.1); margin:0" />
          Mode animateur
        </label>
      </div>

      <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end">
        <button class="btn secondary" id="prevDay">‚Üê Jour</button>
        <button class="btn secondary" id="today">Aujourd‚Äôhui</button>
        <button class="btn secondary" id="nextDay">Jour ‚Üí</button>
        <a class="btn" id="aelfLink" target="_blank" rel="noopener">üìñ √âvangile du jour (AELF)</a>
      </div>
    </div>

    <div style="margin-top:12px">
      <div class="row" style="justify-content:space-between; margin-bottom:8px">
        <span class="pill">Aujourd‚Äôhui : <b id="dayPct">0%</b></span>
        <span class="pill">Semaine : <b id="weekPct">0%</b></span>
        <span class="pill">Car√™me : <b id="seasonPct">0%</b></span>
      </div>
      <div class="progress"><div class="bar" id="dayBar"></div></div>
      <div class="progress" style="margin-top:8px"><div class="bar" id="weekBar"></div></div>
      <div class="progress" style="margin-top:8px"><div class="bar" id="seasonBar"></div></div>
    </div>

    <div class="hr"></div>

    <div class="grid">
      <div class="section">
        <h2>Objectifs du jour</h2>
        <ul id="todayTasks"></ul>

        <div class="foot" id="dayHint"></div>

        <div class="row" style="margin-top:12px; justify-content:flex-start; gap:10px">
          <button class="btn warn" id="resetDay">R√©initialiser le jour</button>
        </div>
      </div>

      <div class="section">
        <h2>Objectifs de la semaine</h2>
        <p class="sub" id="weekLabel" style="margin-bottom:10px"></p>
        <ul id="weekTasks"></ul>

        <div class="hr"></div>

        <h2>Objectifs sur le Car√™me</h2>
        <ul id="seasonTasks"></ul>

        <div class="row" style="margin-top:12px; justify-content:flex-start; gap:10px">
          <button class="btn warn" id="resetWeek">R√©initialiser la semaine</button>
          <button class="btn bad" id="resetAll">Tout r√©initialiser</button>
        </div>

        <div class="foot">
          ‚ÄúSemaine‚Äù = lundi ‚Üí dimanche. Les objectifs s‚Äôadaptent au niveau choisi.
          Les coches sont enregistr√©es sur l‚Äôappareil (pas de compte).
        </div>
      </div>
    </div>

    <!-- MODE ANIMATEUR -->
    <div class="section hidden" id="animatorPanel" style="margin-top:12px">
      <h2>Mode animateur ‚Äì Suivi de groupe (sans serveur)</h2>
      <div class="sub">
        Chaque participant peut g√©n√©rer un <b>code de partage</b> (stats uniquement).<br/>
        Colle ici plusieurs codes (un par ligne) pour obtenir une moyenne de groupe.
      </div>

      <div class="row" style="align-items:flex-start">
        <div style="flex:1; min-width:280px">
          <button class="btn" id="makeShareCode">G√©n√©rer mon code de partage</button>
          <div class="foot">Le code ne contient pas de nom. Il inclut le niveau + des %.</div>
          <textarea id="shareCodeOut" class="mono" readonly placeholder="Ton code appara√Ætra ici‚Ä¶"></textarea>
        </div>

        <div style="flex:1; min-width:280px">
          <textarea id="shareCodesIn" class="mono" placeholder="Colle ici les codes (un par ligne)‚Ä¶"></textarea>
          <div class="row" style="justify-content:flex-start; gap:10px; margin-top:10px">
            <button class="btn" id="computeGroup">Calculer la moyenne du groupe</button>
            <button class="btn secondary" id="clearGroup">Effacer</button>
          </div>

          <div class="quote" style="margin-top:10px">
            <div><b>R√©sultat groupe</b></div>
            <div class="sub" id="groupResult" style="margin-top:6px">Aucun calcul pour l‚Äôinstant.</div>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- MODAL DOUBLE CONFIRM RESET -->
<div class="modal-backdrop" id="resetModal">
  <div class="modal">
    <h3>R√©initialisation totale</h3>
    <p>
      <span class="danger-note">Attention :</span> cela efface toutes les coches enregistr√©es sur cet appareil,
      pour tous les jours et toutes les semaines, et pour tous les niveaux.
    </p>
    <p>
      1) Clique sur <b>Continuer</b><br/>
      2) Puis tape <b class="mono">EFFACER</b> pour confirmer.
    </p>
    <input id="resetConfirmInput" type="text" class="mono" placeholder="Tape EFFACER pour confirmer‚Ä¶" />
    <div class="row" style="margin-top:12px; gap:10px">
      <button class="btn secondary" id="resetCancel">Annuler</button>
      <button class="btn warn" id="resetContinue">Continuer</button>
      <button class="btn bad" id="resetDoIt" aria-disabled="true">Oui, tout effacer</button>
    </div>
  </div>
</div>

<script>
(() => {
  // --- Car√™me 2026 (verrouill√©)
  const START = new Date("2026-02-18T00:00:00"); // Mercredi des Cendres
  const END   = new Date("2026-04-05T00:00:00"); // Dimanche de P√¢ques

  const KEY = "careme_2026_custom_levels_v2";
  const $ = (id) => document.getElementById(id);

  // --- AELF URL
  function aelfUrl(iso){ return `https://www.aelf.org/${iso}/romain/messe`; }

  // --- Courtes paroles (rotation)
  const SHORT_QUOTES = [
    "¬´ Aujourd‚Äôhui, si vous √©coutez sa voix, n‚Äôendurcissez pas votre c≈ìur. ¬ª (Ps 94/95)",
    "¬´ Cherchez d‚Äôabord le Royaume de Dieu. ¬ª (Mt 6,33)",
    "¬´ Seigneur, apprends-nous √† prier. ¬ª (Lc 11,1)",
    "¬´ Heureux les mis√©ricordieux. ¬ª (Mt 5,7)",
    "¬´ Demeurez en mon amour. ¬ª (Jn 15,9)",
    "¬´ Mon joug est facile √† porter. ¬ª (Mt 11,30)",
    "¬´ Je suis avec vous tous les jours. ¬ª (Mt 28,20)"
  ];

  // --- TES 3 NIVEAUX (tels que donn√©s)
  // scope:
  // - daily : √† faire chaque jour
  // - friday : √† faire le vendredi (ou vendredis)
  // - weekday : certains jours (ex: mercredi+vendredi)
  // - weekly : 1x par semaine
  // - season : sur le Car√™me
  // - biweekly15 : tous les 15 jours (approximation simple: coche "p√©riode" ; on garde en "weekly" + note)
  //
  // Remarque: pour "Confession chaque 15 jours" / "Messe quotidienne si possible" etc.
  // On les propose comme objectifs cochables (daily/weekly/season), sans forcer une logique complexe.
  // (Sinon, √ßa devient une usine. Ici, c‚Äôest simple, motivant, et fid√®le au texte.)
  const LEVELS = {
    mustard: {
      name: "Le grain de s√©nev√©",
      quote: "¬´ Le Royaume des cieux est comparable √† un grain de s√©nev√© qu‚Äôun homme a sem√© dans son champ‚Ä¶ ¬ª (Mt 13,31-32)",
      daily: [
        { id:"oraison", label:"Oraison : 15 minutes", cat:"Discipline spirituelle" },
        { id:"dizaine", label:"Chapelet : au moins une dizaine", cat:"Discipline spirituelle" },
        { id:"lecture", label:"Lecture spirituelle : √âvangile / liturgie du jour", cat:"Discipline spirituelle" },
        { id:"sobriete", label:"Sobri√©t√© num√©rique : pas apr√®s 21h (r√©seaux/vid√©os)", cat:"Asc√®se" },
        { id:"sommeil", label:"Sommeil : viser au moins 7h", cat:"Asc√®se" }
      ],
      fridayOnly: [
        { id:"jeune", label:"Je√ªne : 1 jour/semaine (vendredi)", cat:"Asc√®se" },
        { id:"abstinence", label:"Abstinence : viande (vendredi)", cat:"Asc√®se" }
      ],
      weekly: [
        { id:"aumone", label:"Aum√¥ne : 1 geste concret (don/service/temps)", cat:"Charit√© & fraternit√©" },
        { id:"fraternite", label:"Fraternit√© : partager 1x avec bin√¥me/ami/groupe", cat:"Charit√© & fraternit√©" }
      ],
      season: [
        { id:"confession", label:"Confession : au moins 1 fois avant P√¢ques", cat:"Discipline spirituelle" }
      ]
    },

    vine: {
      name: "Le cep et les sarments",
      quote: "¬´ Celui qui demeure en moi et en qui je demeure porte beaucoup de fruit‚Ä¶ ¬ª (Jn 15,5)",
      daily: [
        { id:"oraison", label:"Oraison : 30 minutes", cat:"Discipline spirituelle" },
        { id:"lecture20", label:"Lecture/formation : 20 min", cat:"Discipline spirituelle" },
        { id:"examen", label:"Examen de conscience : chaque soir", cat:"Discipline spirituelle" },
        { id:"sobriete_strict", label:"Sobri√©t√© num√©rique : pas de divertissement (sauf n√©cessaire)", cat:"Asc√®se" },
        { id:"douche", label:"Douches temp√©r√©es ou froides (selon possibilit√©)", cat:"Asc√®se" },
        { id:"sommeil", label:"Sommeil : 7h", cat:"Asc√®se" }
      ],
      // Ici: Je√ªne 2 jours/semaine (mercredi et vendredi)
      weekdayOnly: {
        days: [3,5], // 0=dimanche.. 3=mercredi.. 5=vendredi
        label: "Mercredi & Vendredi",
        tasks: [
          { id:"jeune_mf", label:"Je√ªne : aujourd‚Äôhui (mercredi/vendredi)", cat:"Asc√®se" }
        ]
      },
      // Abstinence: tous les vendredis + un autre jour choisi
      fridayOnly: [
        { id:"abstinence_v", label:"Abstinence : vendredi", cat:"Asc√®se" }
      ],
      weekly: [
        { id:"chapelet_complet", label:"Chapelet : un chapelet complet/semaine (ou plus)", cat:"Discipline spirituelle" },
        { id:"abstinence_plus", label:"Abstinence : un autre jour choisi (en plus du vendredi)", cat:"Asc√®se" },
        { id:"sport2", label:"Exercice physique : 2 s√©ances", cat:"Asc√®se" },
        { id:"aumone2h", label:"Aum√¥ne/service : au moins 2h", cat:"Charit√© & fraternit√©" },
        { id:"fraternite_groupe", label:"Fraternit√© : r√©union hebdo (pri√®re/soutien)", cat:"Charit√© & fraternit√©" }
      ],
      season: [
        { id:"confession2", label:"Confession : 2 fois (dont 1 avant Semaine Sainte)", cat:"Discipline spirituelle" }
      ]
    },

    fire: {
      name: "Feu d√©vorant",
      quote: "¬´ Notre Dieu est un feu d√©vorant. ¬ª (He 12,29)",
      daily: [
        { id:"oraison1h", label:"Oraison : 1h (heure sainte)", cat:"Discipline spirituelle" },
        { id:"chapelet_q", label:"Chapelet : quotidien (int√©gral si possible)", cat:"Discipline spirituelle" },
        { id:"lecture30", label:"Lecture spirituelle : 30 min (√âcriture + auteur)", cat:"Discipline spirituelle" },
        { id:"examen_pro", label:"Examen de conscience : approfondi (√©crit si possible)", cat:"Discipline spirituelle" },
        { id:"sobriete_rad", label:"Sobri√©t√© num√©rique radicale : t√©l√©phone essentiel uniquement", cat:"Asc√®se" },
        { id:"douche_f", label:"Douche froide quotidienne", cat:"Asc√®se" },
        { id:"sommeil7", label:"Sommeil : jamais moins de 7h", cat:"Asc√®se" }
      ],
      // Je√ªne : tous les jours du Car√™me sauf dimanches/solennit√©s -> on coche chaque jour (sauf dimanche)
      // (Ici on applique "sauf dimanches" automatiquement)
      fastingRule: {
        enabled: true,
        id: "jeune_quotidien",
        label: "Je√ªne : aujourd‚Äôhui (sauf dimanche) ‚Äî 1 repas + 2 collations l√©g√®res, sans viande",
        cat: "Asc√®se"
      },
      fridayOnly: [
        { id:"abstinence_strict", label:"Abstinence stricte : viande (vendredi)", cat:"Asc√®se" }
      ],
      weekly: [
        { id:"adoration", label:"Adoration : au moins 1 fois", cat:"Discipline spirituelle" },
        { id:"messe", label:"Messe : quotidienne si possible (objectif semaine)", cat:"Discipline spirituelle" },
        { id:"sport3", label:"Exercice physique : 3 fois", cat:"Asc√®se" },
        { id:"service1h_j", label:"Aum√¥ne/service : 1h par jour (objectif semaine)", cat:"Charit√© & fraternit√©" },
        { id:"checkin_q", label:"Fraternit√© : check-in quotidien (objectif semaine)", cat:"Charit√© & fraternit√©" },
        { id:"rencontre_g", label:"Fraternit√© : rencontre hebdo de groupe", cat:"Charit√© & fraternit√©" },
        { id:"accompagnement", label:"Accompagnement spirituel : r√©gulier", cat:"Charit√© & fraternit√©" }
      ],
      season: [
        { id:"confession15", label:"Confession : chaque 15 jours (cocher quand c‚Äôest fait)", cat:"Discipline spirituelle" }
      ]
    }
  };

  // --- Helpers dates
  function clampToRange(d){
    const x = new Date(d); x.setHours(0,0,0,0);
    if(x < START) return new Date(START);
    if(x > END) return new Date(END);
    return x;
  }
  function toISODate(d){
    const x = new Date(d); x.setHours(0,0,0,0);
    const yyyy = x.getFullYear();
    const mm = String(x.getMonth()+1).padStart(2,'0');
    const dd = String(x.getDate()).padStart(2,'0');
    return `${yyyy}-${mm}-${dd}`;
  }
  function addDays(d, n){
    const x = new Date(d); x.setDate(x.getDate()+n); x.setHours(0,0,0,0); return x;
  }
  function dayOfWeek(d){ return new Date(d).getDay(); } // 0 dimanche .. 6 samedi
  function isFriday(d){ return dayOfWeek(d) === 5; }
  function isSunday(d){ return dayOfWeek(d) === 0; }
  function startOfWeekMonday(d){
    const x = new Date(d); x.setHours(0,0,0,0);
    const day = x.getDay();
    const diff = (day === 0 ? -6 : 1 - day);
    x.setDate(x.getDate()+diff);
    return x;
  }
  function formatFR(d){
    return new Intl.DateTimeFormat('fr-FR', { weekday:'long', year:'numeric', month:'long', day:'numeric' }).format(d);
  }
  function formatShortFR(d){
    return new Intl.DateTimeFormat('fr-FR', { day:'2-digit', month:'2-digit' }).format(d);
  }
  function pct(done, total){ return total ? Math.round((done/total)*100) : 0; }
  function inRangeISO(iso){
    const d = new Date(iso+"T00:00:00");
    return d >= START && d <= END;
  }

  // --- Storage
  function load(){
    try { return JSON.parse(localStorage.getItem(KEY)) || {}; }
    catch { return {}; }
  }
  function save(s){ localStorage.setItem(KEY, JSON.stringify(s)); }

  // state schema:
  // state.level = "mustard"|"vine"|"fire"
  // state.days[iso][level] = { daily:{id:bool}, extra:{id:bool} }
  // state.weeks[weekIsoMonday][level] = { weekly:{id:bool} }
  // state.season[level] = { id: bool }
  let state = load();
  if(!state.level) state.level = "mustard";
  if(!state.days) state.days = {};
  if(!state.weeks) state.weeks = {};
  if(!state.season) state.season = {};

  function ensureDay(iso, level){
    if(!state.days[iso]) state.days[iso] = {};
    if(!state.days[iso][level]) state.days[iso][level] = { daily:{}, extra:{} };

    const L = LEVELS[level];

    (L.daily || []).forEach(t => {
      if(typeof state.days[iso][level].daily[t.id] !== "boolean") state.days[iso][level].daily[t.id] = false;
    });

    // fridayOnly -> stock√© dans extra
    (L.fridayOnly || []).forEach(t => {
      if(typeof state.days[iso][level].extra[t.id] !== "boolean") state.days[iso][level].extra[t.id] = false;
    });

    // weekdayOnly tasks -> stock√© dans extra
    if(L.weekdayOnly && Array.isArray(L.weekdayOnly.tasks)){
      L.weekdayOnly.tasks.forEach(t => {
        if(typeof state.days[iso][level].extra[t.id] !== "boolean") state.days[iso][level].extra[t.id] = false;
      });
    }

    // fasting rule -> stock√© dans extra
    if(L.fastingRule && L.fastingRule.enabled){
      const t = L.fastingRule;
      if(typeof state.days[iso][level].extra[t.id] !== "boolean") state.days[iso][level].extra[t.id] = false;
    }
  }

  function ensureWeek(weekIso, level){
    if(!state.weeks[weekIso]) state.weeks[weekIso] = {};
    if(!state.weeks[weekIso][level]) state.weeks[weekIso][level] = { weekly:{} };
    const L = LEVELS[level];
    (L.weekly || []).forEach(t => {
      if(typeof state.weeks[weekIso][level].weekly[t.id] !== "boolean") state.weeks[weekIso][level].weekly[t.id] = false;
    });
  }

  function ensureSeason(level){
    if(!state.season[level]) state.season[level] = {};
    const L = LEVELS[level];
    (L.season || []).forEach(t => {
      if(typeof state.season[level][t.id] !== "boolean") state.season[level][t.id] = false;
    });
  }

  function weekKey(dayDate){
    const ws = startOfWeekMonday(dayDate);
    return { ws, we: addDays(ws,6), key: toISODate(ws) };
  }

  // --- Current day
  let current = clampToRange(new Date());

  function currentLevel(){ return state.level; }

  function setShortQuote(){
    const daysFromStart = Math.floor((current - START) / (1000*60*60*24));
    const q = SHORT_QUOTES[(daysFromStart % SHORT_QUOTES.length + SHORT_QUOTES.length) % SHORT_QUOTES.length];
    $("shortQuote").textContent = q;
  }

  function updateLevelHeader(){
    const level = currentLevel();
    const L = LEVELS[level];
    $("levelTitle").textContent = `Niveau : ${L.name}`;
    $("levelQuote").textContent = L.quote;
  }

  function updateHeader(){
    const iso = toISODate(current);
    $("dateLabel").textContent = formatFR(current);
    $("rangeLabel").textContent = `Du ${formatShortFR(START)} au ${formatShortFR(END)} (Car√™me 2026)`;
    $("aelfLink").href = aelfUrl(iso);
    $("prevDay").setAttribute("aria-disabled", current <= START ? "true" : "false");
    $("nextDay").setAttribute("aria-disabled", current >= END ? "true" : "false");
    setShortQuote();
    updateLevelHeader();
  }

  function renderToday(){
    const level = currentLevel();
    const L = LEVELS[level];
    const iso = toISODate(current);
    ensureDay(iso, level);

    const list = $("todayTasks");
    list.innerHTML = "";

    const tasks = [];
    (L.daily || []).forEach(t => tasks.push({ ...t, scope:"daily" }));

    // Friday-only
    if(isFriday(current) && (L.fridayOnly || []).length){
      (L.fridayOnly || []).forEach(t => tasks.push({ ...t, scope:"extra", extraTag:"Vendredi" }));
    }

    // Weekday-only (ex mercredi+vendredi)
    if(L.weekdayOnly && Array.isArray(L.weekdayOnly.days) && Array.isArray(L.weekdayOnly.tasks)){
      if(L.weekdayOnly.days.includes(dayOfWeek(current))){
        L.weekdayOnly.tasks.forEach(t => tasks.push({ ...t, scope:"extra", extraTag:L.weekdayOnly.label }));
      }
    }

    // Fire fasting rule: show every day except Sundays
    if(L.fastingRule && L.fastingRule.enabled){
      if(!isSunday(current)){
        const t = L.fastingRule;
        tasks.push({ id:t.id, label:t.label, cat:t.cat, scope:"extra", extraTag:"R√®gle" });
      }
    }

    tasks.forEach(t => {
      const li = document.createElement("li");
      const cb = document.createElement("input");
      cb.type = "checkbox";

      cb.checked = (t.scope === "daily")
        ? state.days[iso][level].daily[t.id]
        : state.days[iso][level].extra[t.id];

      cb.addEventListener("change", () => {
        if(t.scope === "daily") state.days[iso][level].daily[t.id] = cb.checked;
        else state.days[iso][level].extra[t.id] = cb.checked;
        save(state);
        updateProgress();
      });

      const div = document.createElement("div");
      div.className = "task";

      const b = document.createElement("b");
      b.textContent = t.label;

      const meta = document.createElement("div");
      meta.className = "meta";
      meta.textContent = t.cat;

      if(t.extraTag){
        const span = document.createElement("span");
        span.className = "tag";
        span.textContent = t.extraTag;
        meta.appendChild(span);
      }

      div.appendChild(b);
      div.appendChild(meta);

      li.appendChild(cb);
      li.appendChild(div);
      list.appendChild(li);
    });

    // Hint
    const hint = $("dayHint");
    if(isFriday(current)){
      hint.innerHTML = `‚ú® Aujourd‚Äôhui c‚Äôest <b>vendredi</b> : objectifs ‚Äúvendredi‚Äù affich√©s si ton niveau en pr√©voit.`;
    } else if(level === "vine" && dayOfWeek(current) === 3){
      hint.innerHTML = `‚ú® Aujourd‚Äôhui c‚Äôest <b>mercredi</b> : objectif de je√ªne affich√© pour ce niveau.`;
    } else if(level === "fire" && isSunday(current)){
      hint.innerHTML = `üåø <b>Dimanche</b> : jour du Seigneur (le je√ªne n‚Äôest pas affich√© aujourd‚Äôhui).`;
    } else {
      hint.innerHTML = `‚úÖ Un pas √† la fois. Si tu rates un jour, reprends simplement demain.`;
    }
  }

  function renderWeek(){
    const level = currentLevel();
    const L = LEVELS[level];
    const { ws, we, key } = weekKey(current);
    ensureWeek(key, level);

    $("weekLabel").textContent = `Semaine : ${formatShortFR(ws)} ‚Üí ${formatShortFR(we)}`;

    const list = $("weekTasks");
    list.innerHTML = "";

    (L.weekly || []).forEach(t => {
      const li = document.createElement("li");
      const cb = document.createElement("input");
      cb.type = "checkbox";
      cb.checked = state.weeks[key][level].weekly[t.id];

      cb.addEventListener("change", () => {
        state.weeks[key][level].weekly[t.id] = cb.checked;
        save(state);
        updateProgress();
      });

      const div = document.createElement("div");
      div.className = "task";
      const b = document.createElement("b");
      b.textContent = t.label;

      const meta = document.createElement("div");
      meta.className = "meta";
      meta.textContent = t.cat;

      div.appendChild(b);
      div.appendChild(meta);

      li.appendChild(cb);
      li.appendChild(div);
      list.appendChild(li);
    });
  }

  function renderSeason(){
    const level = currentLevel();
    const L = LEVELS[level];
    ensureSeason(level);

    const list = $("seasonTasks");
    list.innerHTML = "";

    (L.season || []).forEach(t => {
      const li = document.createElement("li");
      const cb = document.createElement("input");
      cb.type = "checkbox";
      cb.checked = !!state.season[level][t.id];

      cb.addEventListener("change", () => {
        state.season[level][t.id] = cb.checked;
        save(state);
        updateProgress();
      });

      const div = document.createElement("div");
      div.className = "task";
      const b = document.createElement("b");
      b.textContent = t.label;

      const meta = document.createElement("div");
      meta.className = "meta";
      meta.textContent = t.cat;

      div.appendChild(b);
      div.appendChild(meta);

      li.appendChild(cb);
      li.appendChild(div);
      list.appendChild(li);
    });
  }

  // --- Progress calculations
  function tasksForDay(level, dateObj){
    const L = LEVELS[level];
    const tasks = [];
    (L.daily || []).forEach(t => tasks.push({ ...t, scope:"daily" }));

    if(isFriday(dateObj) && (L.fridayOnly || []).length){
      (L.fridayOnly || []).forEach(t => tasks.push({ ...t, scope:"extra" }));
    }
    if(L.weekdayOnly && Array.isArray(L.weekdayOnly.days) && Array.isArray(L.weekdayOnly.tasks)){
      if(L.weekdayOnly.days.includes(dayOfWeek(dateObj))){
        L.weekdayOnly.tasks.forEach(t => tasks.push({ ...t, scope:"extra" }));
      }
    }
    if(L.fastingRule && L.fastingRule.enabled){
      if(!isSunday(dateObj)){
        const t = L.fastingRule;
        tasks.push({ id:t.id, label:t.label, cat:t.cat, scope:"extra" });
      }
    }
    return tasks;
  }

  function todayProgress(){
    const level = currentLevel();
    const iso = toISODate(current);
    ensureDay(iso, level);

    const list = tasksForDay(level, current);
    let total = list.length, done = 0;

    list.forEach(t => {
      if(t.scope === "daily"){
        if(state.days[iso][level].daily[t.id]) done++;
      } else {
        if(state.days[iso][level].extra[t.id]) done++;
      }
    });

    return { done, total, pct: pct(done,total) };
  }

  function weekProgress(){
    const level = currentLevel();
    const L = LEVELS[level];
    const { ws, key } = weekKey(current);
    ensureWeek(key, level);

    let total = 0, done = 0;

    for(let i=0;i<7;i++){
      const d = addDays(ws, i);
      const iso = toISODate(d);
      if(!inRangeISO(iso)) continue;
      ensureDay(iso, level);

      const list = tasksForDay(level, d);
      total += list.length;
      list.forEach(t => {
        if(t.scope === "daily"){
          if(state.days[iso][level].daily[t.id]) done++;
        } else {
          if(state.days[iso][level].extra[t.id]) done++;
        }
      });
    }

    // weekly tasks
    total += (L.weekly || []).length;
    (L.weekly || []).forEach(t => { if(state.weeks[key][level].weekly[t.id]) done++; });

    return { done, total, pct: pct(done,total) };
  }

  function seasonProgress(){
    const level = currentLevel();
    const L = LEVELS[level];
    ensureSeason(level);

    let total = 0, done = 0;

    // daily + extras across season
    for(let d=new Date(START); d<=END; d=addDays(d,1)){
      const iso = toISODate(d);
      ensureDay(iso, level);

      const list = tasksForDay(level, d);
      total += list.length;
      list.forEach(t => {
        if(t.scope === "daily"){
          if(state.days[iso][level].daily[t.id]) done++;
        } else {
          if(state.days[iso][level].extra[t.id]) done++;
        }
      });
    }

    // weekly tasks across distinct weeks
    const seenWeeks = new Set();
    for(let d=new Date(START); d<=END; d=addDays(d,1)){
      const wk = weekKey(d).key;
      if(seenWeeks.has(wk)) continue;
      seenWeeks.add(wk);
      ensureWeek(wk, level);
      total += (L.weekly || []).length;
      (L.weekly || []).forEach(t => { if(state.weeks[wk][level].weekly[t.id]) done++; });
    }

    // season tasks
    total += (L.season || []).length;
    (L.season || []).forEach(t => { if(state.season[level][t.id]) done++; });

    return { done, total, pct: pct(done,total) };
  }

  function updateProgress(){
    const dp = todayProgress();
    const wp = weekProgress();
    const sp = seasonProgress();

    $("dayPct").textContent = `${dp.pct}%`;
    $("weekPct").textContent = `${wp.pct}%`;
    $("seasonPct").textContent = `${sp.pct}%`;

    $("dayBar").style.width = `${dp.pct}%`;
    $("weekBar").style.width = `${wp.pct}%`;
    $("seasonBar").style.width = `${sp.pct}%`;
  }

  function renderAll(){
    current = clampToRange(current);
    updateHeader();
    renderToday();
    renderWeek();
    renderSeason();
    updateProgress();
  }

  // --- Level select
  function applyLevelFromUI(){
    const lvl = $("levelSelect").value;
    if(!LEVELS[lvl]) return;
    state.level = lvl;
    save(state);
    renderAll();
  }

  // --- Nav
  $("prevDay").addEventListener("click", () => {
    if(current <= START) return;
    current = addDays(current, -1);
    renderAll();
  });
  $("nextDay").addEventListener("click", () => {
    if(current >= END) return;
    current = addDays(current, 1);
    renderAll();
  });
  $("today").addEventListener("click", () => {
    current = clampToRange(new Date());
    renderAll();
  });

  // --- Reset day/week
  $("resetDay").addEventListener("click", () => {
    const level = currentLevel();
    const iso = toISODate(current);
    ensureDay(iso, level);

    // reset keys known for that day (daily + extra that might appear)
    const L = LEVELS[level];
    (L.daily || []).forEach(t => state.days[iso][level].daily[t.id] = false);

    // reset extra keys that exist
    Object.keys(state.days[iso][level].extra || {}).forEach(k => state.days[iso][level].extra[k] = false);

    save(state);
    renderAll();
  });

  $("resetWeek").addEventListener("click", () => {
    const level = currentLevel();
    const { key } = weekKey(current);
    ensureWeek(key, level);
    const L = LEVELS[level];
    (L.weekly || []).forEach(t => state.weeks[key][level].weekly[t.id] = false);
    save(state);
    renderAll();
  });

  // --- Double confirm Reset All (modal + typed word)
  const modal = $("resetModal");
  const input = $("resetConfirmInput");
  const btnDo = $("resetDoIt");
  let stage = 0; // 0 initial, 1 continued

  function openResetModal(){
    stage = 0;
    input.value = "";
    btnDo.setAttribute("aria-disabled","true");
    $("resetContinue").classList.remove("hidden");
    btnDo.classList.add("hidden");
    modal.classList.add("show");
    input.focus();
  }
  function closeResetModal(){
    modal.classList.remove("show");
  }

  $("resetAll").addEventListener("click", openResetModal);
  $("resetCancel").addEventListener("click", closeResetModal);

  $("resetContinue").addEventListener("click", () => {
    stage = 1;
    $("resetContinue").classList.add("hidden");
    btnDo.classList.remove("hidden");
    input.focus();
    validateResetInput();
  });

  function validateResetInput(){
    const ok = stage === 1 && input.value.trim().toUpperCase() === "EFFACER";
    btnDo.setAttribute("aria-disabled", ok ? "false" : "true");
  }
  input.addEventListener("input", validateResetInput);

  btnDo.addEventListener("click", () => {
    if(btnDo.getAttribute("aria-disabled") === "true") return;

    localStorage.removeItem(KEY);
    state = { level: "mustard", days:{}, weeks:{}, season:{} };
    save(state);

    // reset UI
    $("levelSelect").value = "mustard";
    current = clampToRange(new Date());
    closeResetModal();
    renderAll();
  });

  // click outside modal closes
  modal.addEventListener("click", (e) => {
    if(e.target === modal) closeResetModal();
  });

  // --- Mode animateur
  function setAnimatorUI(on){ $("animatorPanel").classList.toggle("hidden", !on); }
  $("animatorToggle").addEventListener("change", () => setAnimatorUI($("animatorToggle").checked));

  function makeShareCode(){
    const iso = toISODate(current);
    const dp = todayProgress().pct;
    const wp = weekProgress().pct;
    const sp = seasonProgress().pct;

    const payload = { v:2, d: iso, lvl: state.level, p:{ day:dp, week:wp, season:sp } };
    const json = JSON.stringify(payload);
    const b64 = btoa(unescape(encodeURIComponent(json)));
    return "CAREME26:" + b64;
  }

  function parseShareCode(line){
    line = (line || "").trim();
    if(!line || !line.startsWith("CAREME26:")) return null;
    const b64 = line.slice("CAREME26:".length);
    try{
      const json = decodeURIComponent(escape(atob(b64)));
      const obj = JSON.parse(json);
      if(!obj || (obj.v !== 2) || !obj.p) return null;
      if(typeof obj.p.day !== "number" || typeof obj.p.week !== "number" || typeof obj.p.season !== "number") return null;
      if(!LEVELS[obj.lvl]) return null;
      return obj;
    }catch{ return null; }
  }

  $("makeShareCode").addEventListener("click", () => {
    $("shareCodeOut").value = makeShareCode();
  });

  $("computeGroup").addEventListener("click", () => {
    const lines = $("shareCodesIn").value.split("\n").map(s => s.trim()).filter(Boolean);
    const parsed = lines.map(parseShareCode).filter(Boolean);

    if(parsed.length === 0){
      $("groupResult").textContent = "Aucun code valide trouv√©. (Ils doivent commencer par CAREME26: ‚Ä¶)";
      return;
    }

    let sumDay=0, sumWeek=0, sumSeason=0;
    const levelsCount = { mustard:0, vine:0, fire:0 };

    parsed.forEach(o => {
      sumDay += o.p.day;
      sumWeek += o.p.week;
      sumSeason += o.p.season;
      levelsCount[o.lvl] += 1;
    });

    const avgDay = Math.round(sumDay / parsed.length);
    const avgWeek = Math.round(sumWeek / parsed.length);
    const avgSeason = Math.round(sumSeason / parsed.length);

    const parts = [];
    parts.push(`Participants : ${parsed.length}`);
    parts.push(`Moyenne aujourd‚Äôhui : ${avgDay}%`);
    parts.push(`Moyenne semaine : ${avgWeek}%`);
    parts.push(`Moyenne Car√™me : ${avgSeason}%`);
    parts.push(`Niveaux : S√©nev√©=${levelsCount.mustard} ¬∑ Cep=${levelsCount.vine} ¬∑ Feu=${levelsCount.fire}`);

    $("groupResult").textContent = parts.join(" ‚Äî ");
  });

  $("clearGroup").addEventListener("click", () => {
    $("shareCodesIn").value = "";
    $("groupResult").textContent = "Aucun calcul pour l‚Äôinstant.";
  });

  // --- init
  $("levelSelect").value = state.level;
  $("levelSelect").addEventListener("change", applyLevelFromUI);
  setAnimatorUI(false);

  save(state);
  current = clampToRange(new Date());
  renderAll();
})();
</script>
</body>
</html>
