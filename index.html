<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Car√™me 2026 ‚Äì Objectifs</title>
  <style>
    :root{
      --bg:#0b1220; --text:#e8eefc; --muted:#a7b4d6;
      --accent:#7aa2ff; --ok:#4ade80; --warn:#fbbf24; --bad:#fb7185;
      --line:rgba(255,255,255,.10);
    }
    body{ margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:linear-gradient(180deg,#070b14,var(--bg)); color:var(--text); }
    .wrap{ max-width:1020px; margin:0 auto; padding:18px; }
    .card{ background:rgba(17,26,46,.88); border:1px solid rgba(122,162,255,.15);
      border-radius:16px; padding:16px; box-shadow:0 10px 30px rgba(0,0,0,.25); }
    h1{ font-size:20px; margin:0 0 6px; }
    h2{ font-size:14px; margin:14px 0 8px; color:var(--muted); font-weight:800; }
    .sub{ color:var(--muted); font-size:13px; margin:0 0 10px; line-height:1.5; }
    .row{ display:flex; gap:12px; flex-wrap:wrap; align-items:center; justify-content:space-between; }
    .pill{ font-size:12px; color:var(--muted); border:1px solid var(--line); padding:6px 10px; border-radius:999px; }
    .btn{ background:rgba(122,162,255,.14); color:var(--text); border:1px solid rgba(122,162,255,.35);
      padding:10px 12px; border-radius:12px; cursor:pointer; text-decoration:none; display:inline-flex; align-items:center; gap:8px; }
    .btn:active{ transform:translateY(1px); }
    .btn[aria-disabled="true"]{ opacity:.45; pointer-events:none; }
    .btn.secondary{ background:rgba(255,255,255,.08); border:1px solid var(--line); }
    .btn.warn{ background:rgba(251,191,36,.10); border:1px solid rgba(251,191,36,.35); }
    .btn.bad{ background:rgba(251,113,133,.10); border:1px solid rgba(251,113,133,.35); }
    .progress{ width:100%; height:10px; background:rgba(255,255,255,.10); border-radius:999px; overflow:hidden; }
    .bar{ height:100%; width:0%; background:linear-gradient(90deg,var(--accent),var(--ok)); transition:width .25s ease; }
    .grid{ display:grid; gap:12px; }
    @media (min-width: 920px){ .grid{ grid-template-columns:1.15fr .85fr; } }

    ul{ list-style:none; padding:0; margin:0; display:flex; flex-direction:column; gap:8px; }
    li{ display:flex; gap:10px; align-items:flex-start; padding:10px; border-radius:12px;
      background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.08); }
    input[type="checkbox"]{ transform:scale(1.25); margin-top:2px; }
    .task{ flex:1; }
    .task b{ display:block; font-weight:800; }
    .meta{ color:var(--muted); font-size:12px; margin-top:2px; }
    .tag{ display:inline-block; font-size:11px; padding:2px 8px; border-radius:999px; border:1px solid var(--line); color:var(--muted); margin-left:6px; }

    .section{ padding:12px; border-radius:14px; border:1px solid var(--line); background:rgba(0,0,0,.12); }
    .foot{ margin-top:10px; color:var(--muted); font-size:12px; line-height:1.5; }
    .hr{ height:1px; background:var(--line); margin:12px 0; }

    select, input[type="text"]{
      background:rgba(0,0,0,.18); color:var(--text);
      border:1px solid rgba(255,255,255,.14); border-radius:12px; padding:10px 12px; font:inherit;
    }

    .quote{ padding:10px 12px; border-radius:12px; border:1px solid rgba(255,255,255,.12); background:rgba(255,255,255,.05); }
    .quote b{ font-weight:900; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .hidden{ display:none; }

    /* Mini modal */
    .modalBackdrop{
      position:fixed; inset:0; background:rgba(0,0,0,.55);
      display:flex; align-items:center; justify-content:center; padding:18px;
    }
    .modal{
      max-width:520px; width:100%;
      background:rgba(17,26,46,.98); border:1px solid rgba(255,255,255,.12);
      border-radius:16px; padding:14px; box-shadow:0 20px 60px rgba(0,0,0,.45);
    }
    .modal h3{ margin:0 0 6px; font-size:16px; }
    .modal .sub{ margin:0 0 10px; }
    .modal .row{ justify-content:flex-start; }
  </style>
</head>

<body>
<div class="wrap">
  <div class="card">
    <div class="row">
      <div>
        <h1>Car√™me 2026 ‚Äì Objectifs</h1>
        <p class="sub" id="dateLabel"></p>
      </div>
      <div class="pill" id="rangeLabel"></div>
    </div>

    <!-- Accueil pastoral + citation du niveau -->
    <div class="quote" style="margin-top:10px">
      <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:flex-start; justify-content:space-between">
        <div style="flex:1; min-width:260px">
          <b>Accueil</b> üôè<br/>
          <span class="sub" style="margin:6px 0 0; display:block">
            Bienvenue dans ce chemin de Car√™me. Ici, on avance avec r√©alisme et confiance :
            un jour √† la fois, pour grandir en pri√®re, sobri√©t√© et charit√©.
          </span>
        </div>
        <div style="flex:1; min-width:260px">
          <b id="levelTitle">Niveau</b><br/>
          <span class="sub" id="levelVerse" style="margin:6px 0 0; display:block"></span>
        </div>
      </div>
    </div>

    <div class="row" style="margin-top:12px">
      <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center">
        <span class="pill">Niveau</span>
        <select id="levelSelect" aria-label="Niveau">
          <option value="1">Le grain de s√©nev√©</option>
          <option value="2">Le cep et les sarments</option>
          <option value="3">Feu d√©vorant</option>
        </select>
      </div>

      <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end">
        <button class="btn secondary" id="prevDay">‚Üê Jour</button>
        <button class="btn secondary" id="today">Aujourd‚Äôhui</button>
        <button class="btn secondary" id="nextDay">Jour ‚Üí</button>
        <a class="btn" id="aelfLink" target="_blank" rel="noopener">üìñ √âvangile du jour (AELF)</a>
      </div>
    </div>

    <div style="margin-top:12px">
      <div class="row" style="justify-content:space-between; margin-bottom:8px">
        <span class="pill">Aujourd‚Äôhui : <b id="dayPct">0%</b></span>
        <span class="pill">Semaine : <b id="weekPct">0%</b></span>
        <span class="pill">Car√™me : <b id="seasonPct">0%</b></span>
      </div>
      <div class="progress"><div class="bar" id="dayBar"></div></div>
      <div class="progress" style="margin-top:8px"><div class="bar" id="weekBar"></div></div>
      <div class="progress" style="margin-top:8px"><div class="bar" id="seasonBar"></div></div>
    </div>

    <div class="hr"></div>

    <div class="grid">
      <div class="section">
        <h2>Objectifs du jour</h2>
        <ul id="todayTasks"></ul>
        <div class="foot" id="dayHint"></div>
        <div class="row" style="margin-top:12px; justify-content:flex-start; gap:10px">
          <button class="btn warn" id="resetDay">R√©initialiser le jour</button>
        </div>
      </div>

      <div class="section">
        <h2>Objectifs de la semaine</h2>
        <p class="sub" id="weekLabel" style="margin-bottom:10px"></p>
        <ul id="weekTasks"></ul>

        <div class="hr"></div>

        <h2>Avant P√¢ques / sur la dur√©e</h2>
        <ul id="seasonTasks"></ul>

        <div class="row" style="margin-top:12px; justify-content:flex-start; gap:10px">
          <button class="btn warn" id="resetWeek">R√©initialiser la semaine</button>
          <button class="btn bad" id="resetAll">Tout r√©initialiser</button>
        </div>

        <div class="foot">
          ‚ÄúSemaine‚Äù = lundi ‚Üí dimanche. Le bouton AELF ouvre la messe du jour.
        </div>
      </div>
    </div>

    <!-- Image en bas -->
    <div class="hr"></div>
    <div class="section" style="text-align:center">
      <h2>Parcours</h2>
      <img
        src="parcours-christus.png"
        alt="Parcours Christus"
        style="width:100%; max-width:520px; height:auto; border-radius:14px; border:1px solid rgba(255,255,255,.12); background:rgba(0,0,0,.10);"
      />
      <div class="foot">Tu peux enregistrer cette page sur l‚Äô√©cran d‚Äôaccueil pour l‚Äôutiliser comme une appli.</div>
    </div>

  </div>
</div>

<script>
(() => {
  // --- P√©riode Car√™me 2026 (verrouill√©e)
  const START = new Date("2026-02-18T00:00:00"); // Mercredi des Cendres
  const END   = new Date("2026-04-05T00:00:00"); // Dimanche de P√¢ques

  const KEY = "careme_2026_custom_levels_v3";
  const $ = (id) => document.getElementById(id);

  // --- AELF URL (messe du jour)
  function aelfUrl(iso){ return `https://www.aelf.org/${iso}/romain/messe`; }

  // --- Niveaux + versets
  const LEVEL_META = {
    1: {
      name: "Le grain de s√©nev√©",
      verse: "¬´ Le Royaume des cieux est comparable √† un grain de s√©nev√© qu‚Äôun homme a sem√© dans son champ‚Ä¶ ¬ª (Mt 13,31-32)"
    },
    2: {
      name: "Le cep et les sarments",
      verse: "¬´ Celui qui demeure en moi et en qui je demeure porte beaucoup de fruit‚Ä¶ ¬ª (Jn 15,5)"
    },
    3: {
      name: "Feu d√©vorant",
      verse: "¬´ Notre Dieu est un feu d√©vorant. ¬ª (He 12,29)"
    }
  };

  // --- Objectifs
  const LEVELS = {
    1: {
      daily: [
        { id:"oraison", label:"Oraison : 15 minutes", cat:"Discipline spirituelle" },
        { id:"chapelet", label:"Chapelet : au moins une dizaine", cat:"Discipline spirituelle" },
        { id:"lecture", label:"Lecture spirituelle : √âvangile ou liturgie du jour", cat:"Discipline spirituelle" },
        { id:"sobriete", label:"Sobri√©t√© num√©rique : pas apr√®s 21h", cat:"Asc√®se" },
        { id:"sommeil", label:"Sommeil : viser au moins 7h", cat:"Asc√®se" },
      ],
      weekdayOnly: [
        { id:"jeune_vendredi", label:"Je√ªne : 1 jour/semaine (vendredi)", cat:"Asc√®se", days:[5] },
        { id:"abstinence_vendredi", label:"Abstinence : le vendredi (viande)", cat:"Asc√®se", days:[5] },
      ],
      weekly: [
        { id:"aumone", label:"Aum√¥ne : 1 geste concret", cat:"Charit√© & fraternit√©" },
        { id:"fraternite", label:"Fraternit√© : partager 1 fois dans la semaine", cat:"Charit√© & fraternit√©" },
      ],
      season: [
        { id:"confession", label:"Confession : au moins 1 fois avant P√¢ques", cat:"Discipline spirituelle" },
      ],
      periodic: []
    },

    2: {
      daily: [
        { id:"oraison", label:"Oraison : 30 minutes", cat:"Discipline spirituelle" },
        { id:"lecture_20", label:"Lecture/formation : 20 minutes", cat:"Discipline spirituelle" },
        { id:"examen", label:"Examen de conscience : chaque soir", cat:"Discipline spirituelle" },
        { id:"sobriete_strict", label:"Sobri√©t√© num√©rique : pas de r√©seaux sociaux/vid√©os (sauf n√©cessaire)", cat:"Asc√®se" },
        { id:"douche_temperee", label:"Douches temp√©r√©es ou froides (selon possibilit√©)", cat:"Asc√®se" },
        { id:"sommeil", label:"Sommeil : 7h/nuit", cat:"Asc√®se" },
      ],
      weekdayOnly: [
        { id:"jeune_mercredi", label:"Je√ªne : mercredi", cat:"Asc√®se", days:[3] },
        { id:"jeune_vendredi", label:"Je√ªne : vendredi", cat:"Asc√®se", days:[5] },
        { id:"abstinence_vendredi", label:"Abstinence : tous les vendredis", cat:"Asc√®se", days:[5] },
        { id:"abstinence_autre", label:"Abstinence : un autre jour choisi", cat:"Asc√®se", days:[0,1,2,3,4,6] },
      ],
      weekly: [
        { id:"chapelet_complet", label:"Chapelet : 1 chapelet complet/semaine (ou quotidien si possible)", cat:"Discipline spirituelle" },
        { id:"sport_2", label:"Exercice physique : 2 s√©ances/semaine", cat:"Asc√®se" },
        { id:"aumone_2h", label:"Aum√¥ne : au moins 2h de service/charit√©", cat:"Charit√© & fraternit√©" },
        { id:"fraternite_groupe", label:"Fraternit√© : r√©union hebdomadaire (bin√¥me/groupe)", cat:"Charit√© & fraternit√©" },
      ],
      season: [
        { id:"confession_2", label:"Confession : 2 fois durant le Car√™me (‚â• 1 avant la Semaine Sainte)", cat:"Discipline spirituelle" },
      ],
      periodic: []
    },

    3: {
      daily: [
        { id:"oraison_1h", label:"Oraison : 1h/jour (style heure sainte)", cat:"Discipline spirituelle" },
        { id:"chapelet_quot", label:"Chapelet : quotidien, int√©gral si possible", cat:"Discipline spirituelle" },
        { id:"lecture_30", label:"Lecture spirituelle : 30 min (√âcriture + auteur)", cat:"Discipline spirituelle" },
        { id:"examen_prof", label:"Examen approfondi : chaque soir (√©crit si possible)", cat:"Discipline spirituelle" },
        { id:"sobriete_rad", label:"Sobri√©t√© num√©rique radicale : t√©l√©phone pour l‚Äôessentiel", cat:"Asc√®se" },
        { id:"douche_froide", label:"Douche froide quotidienne", cat:"Asc√®se" },
        { id:"sommeil_reg", label:"Sommeil : r√©gulier, jamais < 7h", cat:"Asc√®se" },
        { id:"aumone_1h", label:"Aum√¥ne/service : 1h/jour", cat:"Charit√© & fraternit√©" },
        { id:"checkin_quot", label:"Fraternit√© : check-in quotidien avec un compagnon", cat:"Charit√© & fraternit√©" },
      ],
      weekdayOnly: [
        { id:"jeune_tous", label:"Je√ªne : tous les jours du Car√™me (sauf dimanches/solennit√©s)", cat:"Asc√®se", days:[1,2,3,4,5,6] },
        { id:"abstinence_vendredi", label:"Abstinence stricte : viande tous les vendredis", cat:"Asc√®se", days:[5] },
      ],
      weekly: [
        { id:"adoration", label:"Adoration : au moins 1 fois/semaine", cat:"Discipline spirituelle" },
        { id:"messe", label:"Messe : quotidienne si possible (au moins 1 fois/semaine en plus du dimanche)", cat:"Discipline spirituelle" },
        { id:"sport_3", label:"Exercice physique : 3 fois/semaine", cat:"Asc√®se" },
        { id:"fraternite_groupe", label:"Fraternit√© : rencontre hebdomadaire de groupe", cat:"Charit√© & fraternit√©" },
        { id:"accompagnement", label:"Accompagnement spirituel : r√©gulier", cat:"Charit√© & fraternit√©" },
        { id:"privation_autre", label:"Autre privation choisie (alcool/sucreries/etc.) ‚Äì tenir la semaine", cat:"Asc√®se" },
      ],
      season: [],
      periodic: [
        { id:"confession_15j", label:"Confession : chaque 15 jours", cat:"Discipline spirituelle", everyDays:15 }
      ]
    }
  };

  // --- Helpers dates
  function clampToRange(d){
    const x = new Date(d); x.setHours(0,0,0,0);
    if(x < START) return new Date(START);
    if(x > END) return new Date(END);
    return x;
  }
  function toISODate(d){
    const x = new Date(d); x.setHours(0,0,0,0);
    const yyyy = x.getFullYear();
    const mm = String(x.getMonth()+1).padStart(2,'0');
    const dd = String(x.getDate()).padStart(2,'0');
    return `${yyyy}-${mm}-${dd}`;
  }
  function addDays(d, n){
    const x = new Date(d); x.setDate(x.getDate()+n); x.setHours(0,0,0,0); return x;
  }
  function dayOfWeek(d){ return new Date(d).getDay(); } // 0 Sun .. 6 Sat
  function startOfWeekMonday(d){
    const x = new Date(d); x.setHours(0,0,0,0);
    const day = x.getDay();
    const diff = (day === 0 ? -6 : 1 - day);
    x.setDate(x.getDate()+diff);
    return x;
  }
  function formatFR(d){
    return new Intl.DateTimeFormat('fr-FR', { weekday:'long', year:'numeric', month:'long', day:'numeric' }).format(d);
  }
  function formatShortFR(d){
    return new Intl.DateTimeFormat('fr-FR', { day:'2-digit', month:'2-digit' }).format(d);
  }
  function pct(done, total){ return total ? Math.round((done/total)*100) : 0; }
  function inRangeISO(iso){
    const d = new Date(iso+"T00:00:00");
    return d >= START && d <= END;
  }
  function daysBetween(a,b){
    return Math.round((b - a)/(1000*60*60*24));
  }

  // --- Storage
  function load(){
    try { return JSON.parse(localStorage.getItem(KEY)) || {}; }
    catch { return {}; }
  }
  function save(s){ localStorage.setItem(KEY, JSON.stringify(s)); }

  let state = load();
  if(!state.level) state.level = 1;
  if(!state.days) state.days = {};
  if(!state.weeks) state.weeks = {};
  if(!state.season) state.season = {};
  if(!state.periodic) state.periodic = {};

  function lvl(){ return String(state.level); }

  function ensureDay(iso, level){
    if(!state.days[iso]) state.days[iso] = {};
    if(!state.days[iso][level]) state.days[iso][level] = { daily:{}, weekdayOnly:{} };

    LEVELS[level].daily.forEach(t => {
      if(typeof state.days[iso][level].daily[t.id] !== "boolean") state.days[iso][level].daily[t.id] = false;
    });

    LEVELS[level].weekdayOnly.forEach(t => {
      if(typeof state.days[iso][level].weekdayOnly[t.id] !== "boolean") state.days[iso][level].weekdayOnly[t.id] = false;
    });
  }

  function ensureWeek(weekIso, level){
    if(!state.weeks[weekIso]) state.weeks[weekIso] = {};
    if(!state.weeks[weekIso][level]) state.weeks[weekIso][level] = { weekly:{} };

    LEVELS[level].weekly.forEach(t => {
      if(typeof state.weeks[weekIso][level].weekly[t.id] !== "boolean") state.weeks[weekIso][level].weekly[t.id] = false;
    });
  }

  function ensureSeason(level){
    if(!state.season[level]) state.season[level] = { season:{} };
    LEVELS[level].season.forEach(t => {
      if(typeof state.season[level].season[t.id] !== "boolean") state.season[level].season[t.id] = false;
    });
  }

  function ensurePeriodic(level){
    if(!state.periodic[level]) state.periodic[level] = { periodic:{} };
    LEVELS[level].periodic.forEach(t => {
      if(!state.periodic[level].periodic[t.id]) state.periodic[level].periodic[t.id] = {};
    });
  }

  function weekKey(dayDate){
    const ws = startOfWeekMonday(dayDate);
    return { ws, we: addDays(ws,6), key: toISODate(ws) };
  }

  let current = clampToRange(new Date());

  function updateHeader(){
    const iso = toISODate(current);
    $("dateLabel").textContent = formatFR(current);
    $("rangeLabel").textContent = `Du ${formatShortFR(START)} au ${formatShortFR(END)} (Car√™me 2026)`;
    $("aelfLink").href = aelfUrl(iso);

    $("prevDay").setAttribute("aria-disabled", current <= START ? "true" : "false");
    $("nextDay").setAttribute("aria-disabled", current >= END ? "true" : "false");

    const meta = LEVEL_META[parseInt(state.level,10)];
    $("levelTitle").textContent = meta.name;
    $("levelVerse").textContent = meta.verse;
  }

  function tasksTodayFor(level, date){
    const out = [];
    LEVELS[level].daily.forEach(t => out.push({ ...t, scope:"daily" }));
    const dow = dayOfWeek(date);
    LEVELS[level].weekdayOnly.forEach(t => {
      if(t.days && t.days.includes(dow)){
        let extra = null;
        if(dow === 5) extra = "Vendredi";
        else if(dow === 3) extra = "Mercredi";
        else extra = "Jour";
        out.push({ ...t, scope:"weekdayOnly", extra });
      }
    });
    return out;
  }

  function renderToday(){
    const level = lvl();
    const iso = toISODate(current);
    ensureDay(iso, level);

    const list = $("todayTasks");
    list.innerHTML = "";

    const tasks = tasksTodayFor(level, current);
    tasks.forEach(t => {
      const li = document.createElement("li");
      const cb = document.createElement("input");
      cb.type = "checkbox";
      cb.checked = (t.scope === "daily")
        ? state.days[iso][level].daily[t.id]
        : state.days[iso][level].weekdayOnly[t.id];

      cb.addEventListener("change", () => {
        if(t.scope === "daily") state.days[iso][level].daily[t.id] = cb.checked;
        else state.days[iso][level].weekdayOnly[t.id] = cb.checked;
        save(state);
        updateProgress();
      });

      const div = document.createElement("div");
      div.className = "task";
      const b = document.createElement("b");
      b.textContent = t.label;
      const meta = document.createElement("div");
      meta.className = "meta";
      meta.textContent = t.cat;

      if(t.extra){
        const span = document.createElement("span");
        span.className = "tag";
        span.textContent = t.extra;
        meta.appendChild(span);
      }

      div.appendChild(b);
      div.appendChild(meta);

      li.appendChild(cb);
      li.appendChild(div);
      list.appendChild(li);
    });

    const dow = dayOfWeek(current);
    let hint = "‚úÖ Un pas √† la fois. Si tu rates un jour, reprends simplement demain.";
    if(dow === 5) hint = "‚ú® Aujourd‚Äôhui c‚Äôest <b>vendredi</b> : objectifs sp√©cifiques affich√©s.";
    if(dow === 3 && level === "2") hint = "‚ú® Aujourd‚Äôhui c‚Äôest <b>mercredi</b> : je√ªne affich√© (niveau ‚Äúcep et sarments‚Äù).";
    if(level === "3" && dow !== 0) hint = "üî• Niveau ‚Äúfeu d√©vorant‚Äù : je√ªne affich√© tous les jours sauf dimanche.";
    if(level === "3" && dow === 0) hint = "üåø Dimanche : pas de je√ªne ‚Äî garde la joie et l‚Äôaction de gr√¢ce.";
    $("dayHint").innerHTML = hint;
  }

  function renderWeek(){
    const level = lvl();
    const { ws, we, key } = weekKey(current);
    ensureWeek(key, level);

    $("weekLabel").textContent = `Semaine : ${formatShortFR(ws)} ‚Üí ${formatShortFR(we)}`;

    const list = $("weekTasks");
    list.innerHTML = "";

    LEVELS[level].weekly.forEach(t => {
      const li = document.createElement("li");
      const cb = document.createElement("input");
      cb.type = "checkbox";
      cb.checked = state.weeks[key][level].weekly[t.id];

      cb.addEventListener("change", () => {
        state.weeks[key][level].weekly[t.id] = cb.checked;
        save(state);
        updateProgress();
      });

      const div = document.createElement("div");
      div.className = "task";
      const b = document.createElement("b");
      b.textContent = t.label;
      const meta = document.createElement("div");
      meta.className = "meta";
      meta.textContent = t.cat;

      div.appendChild(b);
      div.appendChild(meta);

      li.appendChild(cb);
      li.appendChild(div);
      list.appendChild(li);
    });
  }

  function periodicPeriodsForTask(task){
    const totalDays = daysBetween(START, END) + 1;
    return Math.ceil(totalDays / task.everyDays);
  }
  function periodIndexForDate(task, date){
    const offset = daysBetween(START, date);
    return Math.floor(offset / task.everyDays);
  }

  function renderSeason(){
    const level = lvl();
    ensureSeason(level);
    ensurePeriodic(level);

    const list = $("seasonTasks");
    list.innerHTML = "";

    LEVELS[level].season.forEach(t => {
      const li = document.createElement("li");
      const cb = document.createElement("input");
      cb.type = "checkbox";
      cb.checked = !!state.season[level].season[t.id];

      cb.addEventListener("change", () => {
        state.season[level].season[t.id] = cb.checked;
        save(state);
        updateProgress();
      });

      const div = document.createElement("div");
      div.className = "task";
      const b = document.createElement("b");
      b.textContent = t.label;
      const meta = document.createElement("div");
      meta.className = "meta";
      meta.textContent = t.cat;

      div.appendChild(b);
      div.appendChild(meta);

      li.appendChild(cb);
      li.appendChild(div);
      list.appendChild(li);
    });

    LEVELS[level].periodic.forEach(t => {
      const li = document.createElement("li");
      const pIdx = periodIndexForDate(t, current);
      const key = "p" + pIdx;

      if(typeof state.periodic[level].periodic[t.id][key] !== "boolean"){
        state.periodic[level].periodic[t.id][key] = false;
        save(state);
      }

      const cb = document.createElement("input");
      cb.type = "checkbox";
      cb.checked = !!state.periodic[level].periodic[t.id][key];

      cb.addEventListener("change", () => {
        state.periodic[level].periodic[t.id][key] = cb.checked;
        save(state);
        updateProgress();
      });

      const div = document.createElement("div");
      div.className = "task";
      const totalPeriods = periodicPeriodsForTask(t);
      const b = document.createElement("b");
      b.textContent = t.label;

      const meta = document.createElement("div");
      meta.className = "meta";
      meta.textContent = `${t.cat} ¬∑ P√©riode ${pIdx+1}/${totalPeriods} (tous les ${t.everyDays} jours)`;
      const span = document.createElement("span");
      span.className = "tag";
      span.textContent = "P√©riodique";
      meta.appendChild(span);

      div.appendChild(b);
      div.appendChild(meta);

      li.appendChild(cb);
      li.appendChild(div);
      list.appendChild(li);
    });
  }

  function todayProgress(){
    const level = lvl();
    const iso = toISODate(current);
    ensureDay(iso, level);

    const tasks = tasksTodayFor(level, current);
    let done = 0;
    tasks.forEach(t => {
      const v = (t.scope === "daily") ? state.days[iso][level].daily[t.id] : state.days[iso][level].weekdayOnly[t.id];
      if(v) done++;
    });
    return { done, total: tasks.length, pct: pct(done, tasks.length) };
  }

  function weekProgress(){
    const level = lvl();
    const { ws, key } = weekKey(current);
    ensureWeek(key, level);

    let total = 0, done = 0;

    for(let i=0;i<7;i++){
      const d = new Date(ws); d.setDate(ws.getDate()+i); d.setHours(0,0,0,0);
      const iso = toISODate(d);
      if(!inRangeISO(iso)) continue;

      ensureDay(iso, level);
      const tasks = tasksTodayFor(level, d);
      total += tasks.length;
      tasks.forEach(t => {
        const v = (t.scope === "daily") ? state.days[iso][level].daily[t.id] : state.days[iso][level].weekdayOnly[t.id];
        if(v) done++;
      });
    }

    total += LEVELS[level].weekly.length;
    LEVELS[level].weekly.forEach(t => { if(state.weeks[key][level].weekly[t.id]) done++; });

    return { done, total, pct: pct(done,total) };
  }

  function seasonProgress(){
    const level = lvl();
    ensureSeason(level);
    ensurePeriodic(level);

    let total = 0, done = 0;

    for(let d=new Date(START); d<=END; d=addDays(d,1)){
      const iso = toISODate(d);
      ensureDay(iso, level);
      const tasks = tasksTodayFor(level, d);
      total += tasks.length;
      tasks.forEach(t => {
        const v = (t.scope === "daily") ? state.days[iso][level].daily[t.id] : state.days[iso][level].weekdayOnly[t.id];
        if(v) done++;
      });
    }

    const seenWeeks = new Set();
    for(let d=new Date(START); d<=END; d=addDays(d,1)){
      const wk = weekKey(d).key;
      if(seenWeeks.has(wk)) continue;
      seenWeeks.add(wk);
      ensureWeek(wk, level);
      total += LEVELS[level].weekly.length;
      LEVELS[level].weekly.forEach(t => { if(state.weeks[wk][level].weekly[t.id]) done++; });
    }

    total += LEVELS[level].season.length;
    LEVELS[level].season.forEach(t => { if(state.season[level].season[t.id]) done++; });

    LEVELS[level].periodic.forEach(t => {
      const n = periodicPeriodsForTask(t);
      total += n;
      for(let i=0;i<n;i++){
        if(!!state.periodic[level].periodic[t.id]["p"+i]) done++;
      }
    });

    return { done, total, pct: pct(done,total) };
  }

  function updateProgress(){
    const dp = todayProgress();
    const wp = weekProgress();
    const sp = seasonProgress();

    $("dayPct").textContent = `${dp.pct}%`;
    $("weekPct").textContent = `${wp.pct}%`;
    $("seasonPct").textContent = `${sp.pct}%`;

    $("dayBar").style.width = `${dp.pct}%`;
    $("weekBar").style.width = `${wp.pct}%`;
    $("seasonBar").style.width = `${sp.pct}%`;
  }

  function renderAll(){
    current = clampToRange(current);
    updateHeader();
    renderToday();
    renderWeek();
    renderSeason();
    updateProgress();
  }

  function applyLevelFromUI(){
    const v = parseInt($("levelSelect").value,10);
    state.level = (v===1||v===2||v===3) ? v : 1;
    save(state);
    renderAll();
  }

  $("prevDay").addEventListener("click", () => {
    if(current <= START) return;
    current = addDays(current, -1);
    renderAll();
  });
  $("nextDay").addEventListener("click", () => {
    if(current >= END) return;
    current = addDays(current, 1);
    renderAll();
  });
  $("today").addEventListener("click", () => {
    current = clampToRange(new Date());
    renderAll();
  });

  $("resetDay").addEventListener("click", () => {
    const level = lvl();
    const iso = toISODate(current);
    ensureDay(iso, level);
    const tasks = tasksTodayFor(level, current);
    tasks.forEach(t => {
      if(t.scope === "daily") state.days[iso][level].daily[t.id] = false;
      else state.days[iso][level].weekdayOnly[t.id] = false;
    });
    save(state);
    renderAll();
  });

  $("resetWeek").addEventListener("click", () => {
    const level = lvl();
    const { key } = weekKey(current);
    ensureWeek(key, level);
    LEVELS[level].weekly.forEach(t => state.weeks[key][level].weekly[t.id] = false);
    save(state);
    renderAll();
  });

  // --- Reset total (simple et fiable)
$("resetAll").addEventListener("click", () => {
  const ok = confirm("√ätes-vous s√ªr de vouloir tout r√©initialiser ?\n\nCette action effacera toutes les coches enregistr√©es sur cet appareil.");
  if(!ok) return;

  localStorage.removeItem(KEY);
  state = { level: 1, days:{}, weeks:{}, season:{}, periodic:{} };
  save(state);

  $("levelSelect").value = "1";
  renderAll();
});

  // init
  $("levelSelect").value = String(state.level || 1);
  $("levelSelect").addEventListener("change", applyLevelFromUI);

  save(state);
  current = clampToRange(new Date());
  renderAll();
})();
</script>
</body>
</html>
